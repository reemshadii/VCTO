<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | VCTO</title>
    <style>
        :root { --bg-color: #0b0c15; --card-bg: #161b2c; --sidebar-bg: #111422; --text-primary: #ffffff; --text-secondary: #a0aec0; --accent-color: #6366f1; --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); --border-color: #2d3748; --error-color: #ef4444; }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); padding: 2rem; display: flex; flex-direction: column; }
        .brand { font-size: 2rem; font-weight: 900; letter-spacing: 1px; color: white; line-height: 1; margin-bottom: 5px; }
        .subtitle { font-size: 0.75rem; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; margin-bottom: 3rem; }
        .nav-link { color: var(--text-secondary); text-decoration: none; padding: 14px; margin-bottom: 8px; border-radius: 8px; font-weight: 500; transition: all 0.2s ease; display: block; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background-color: rgba(99, 102, 241, 0.1); color: var(--accent-color); border-left: 3px solid var(--accent-color); }
        
        /* CONTENT */
        .main-content { flex: 1; padding: 2.5rem; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        h1 { margin: 0; font-size: 2rem; }
        .user-badge { background: var(--card-bg); padding: 8px 16px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-secondary); }
        .user-badge span { color: white; font-weight: bold; }
        
        .dashboard-view { display: none; }
        .dashboard-view.active { display: block; }
        .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; height: auto; flex-wrap: wrap; }
        .tool-btn { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: all 0.2s; white-space: nowrap; }
        .tool-btn:hover { border-color: var(--accent-color); color: white; }
        .tool-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .tool-btn.primary { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .tool-btn.danger { color: var(--error-color); border-color: var(--error-color); }
        .tool-btn.danger:hover { background: var(--error-color); color: white; }
        .spacer { flex: 1; } 

        .outfit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; }
        
        /* Dragging Styles */
        .outfit-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; position: relative; cursor: grab; transition: all 0.2s; }
        .outfit-card.dragging { opacity: 0.5; border: 2px dashed var(--accent-color); }
        
        .selection-active .outfit-card { cursor: pointer; border-color: var(--accent-color); }
        .select-overlay { position: absolute; top: 10px; left: 10px; z-index: 10; display: none; }
        .selection-active .select-overlay { display: block; }
        .select-check { width: 25px; height: 25px; cursor: pointer; accent-color: var(--accent-color); pointer-events: none; }
        
        .outfit-img { height: 180px; background: #000; width: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); pointer-events: none; overflow: hidden; }
        .outfit-info { padding: 1rem; pointer-events: none; }
        .outfit-info h4 { margin: 0 0 5px 0; color: white; font-size: 1rem; }
        .outfit-info p { margin: 0; font-size: 0.8rem; color: var(--text-secondary); }
        
        .card-actions { padding: 0 1rem 1rem 1rem; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .action-group-left { display: flex; gap: 15px; align-items: center; }
        .text-btn { background: none; border: none; font-size: 0.85rem; cursor: pointer; padding: 0; text-decoration: underline; }
        .edit-btn { color: var(--accent-color); }
        .delete-btn { color: var(--error-color); }
        .download-btn { background: none; border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 4px 8px; font-size: 0.9rem; cursor: pointer; }
        .selection-active .card-actions { pointer-events: none; opacity: 0.3; }

        .danger-zone { border: 1px solid var(--error-color); background: rgba(239, 68, 68, 0.05); padding: 2rem; border-radius: 12px; margin-top: 2rem; }
        .delete-input { background: #0b0c15; border: 1px solid var(--border-color); padding: 10px; color: white; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .delete-confirm-btn { background: var(--error-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border-color); }
        .card h3 { margin-top: 0; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        .card .value { font-size: 2.2rem; font-weight: 700; margin: 10px 0; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .user-badge { display: none; }
            
            .sidebar { 
                width: 100%; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border-color); 
                display: flex; flex-direction: row; flex-wrap: wrap; justify-content: space-between; align-items: center; box-sizing: border-box;
            }
            .brand, .subtitle { display: none; }
            
            .nav-link { 
                flex: 1 1 30%; 
                text-align: center; margin: 5px; padding: 10px 5px; 
                font-size: 0.8rem; white-space: nowrap; border: 1px solid var(--border-color);
            }
            .nav-link.active { border-color: var(--accent-color); border-left: 1px solid var(--accent-color); }
            
            .main-content { padding: 1.5rem; }
            .outfit-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div>
            <div class="brand">VCTO</div>
            <div class="subtitle">Virtual Clothes Try-On</div>
        </div>
        <a onclick="switchView('overview')" class="nav-link active" id="link-overview">Overview</a>
        <a onclick="switchView('saved')" class="nav-link" id="link-saved">Saved Outfits</a>
        <a onclick="switchView('favorites')" class="nav-link" id="link-favorites">Favorites</a>
        <a onclick="switchView('settings')" class="nav-link" id="link-settings">Settings</a>
        <a class="nav-link" href="faq.html">Help & FAQ</a>
        <a class="nav-link" href="index.html" style="color:white; background:#2d3748;">← Home</a>
        <a href="#" onclick="logout()" class="nav-link" style="color: #ef4444;">Log Out</a>
    </nav>

    <main class="main-content" id="main-container">
        <header>
            <h1 id="page-title">Dashboard</h1>
            <div class="user-badge">Logged in as: <span id="user-email-display">Guest</span></div>
        </header>

        <div id="view-overview" class="dashboard-view active">
            <div class="stats-grid">
                <div class="card"><h3>Tracking Status</h3><div class="value" style="-webkit-text-fill-color: #10b981;">Active</div></div>
                <div class="card"><h3>Outfits Generated</h3><div class="value" id="total-outfits">0</div></div>
            </div>
            <div class="card">
                <h2>Welcome Back!</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Start a new simulation to see your activity here.</p>
                <button onclick="window.location.href='simulator.html'" style="background: var(--accent-gradient); border:none; color:white; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">+ Start Simulator</button>
            </div>
        </div>

        <div id="view-saved" class="dashboard-view">
            <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:1rem;font-style:italic;" id="drag-tip-saved">Tip: Drag and drop cards to reorder.</p>
            <div class="toolbar" id="toolbar-saved"></div>
            <div class="outfit-grid" id="saved-outfits-container"></div>
        </div>

        <div id="view-favorites" class="dashboard-view">
            <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:1rem;font-style:italic;" id="drag-tip-favorites">Tip: Drag and drop cards to reorder.</p>
             <div class="toolbar" id="toolbar-favorites"></div>
            <div class="outfit-grid" id="favorites-container"></div>
        </div>

        <div id="view-settings" class="dashboard-view">
            <div class="danger-zone">
                <div style="color: var(--error-color); font-weight: bold; margin-bottom: 1rem;">⚠ Delete Account</div>
                <p style="color:var(--text-secondary); margin-bottom:1.5rem;">Once deleted, there is no going back.</p>
                <input type="password" id="delete-password" class="delete-input" placeholder="Current Password">
                <button onclick="deleteAccount()" class="delete-confirm-btn">Delete My Account</button>
            </div>
        </div>
    </main>

    <script>
        const currentUserData = localStorage.getItem('currentUser');
        let currentUser = null;
        if (currentUserData) { currentUser = JSON.parse(currentUserData); document.getElementById('user-email-display').innerText = currentUser.email; } 
        else { alert("Sign in first!"); window.location.href = "index.html"; }

        let savedOutfits = JSON.parse(localStorage.getItem('vcto_saved_outfits')) || [];
        document.getElementById('total-outfits').innerText = savedOutfits.length;

        // --- INDEPENDENT STATE PERSISTENCE ---
        let savedSortState = localStorage.getItem('vcto_saved_sort') || 'custom';
        let favSortState = localStorage.getItem('vcto_fav_sort') || 'custom';
        
        let selectedIds = new Set();
        let currentView = 'saved';
        let isSelectionMode = false;

        function getCurrentSortState() {
            return currentView === 'favorites' ? favSortState : savedSortState;
        }

        function renderToolbar() {
            const containerId = currentView === 'favorites' ? 'toolbar-favorites' : 'toolbar-saved';
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            const currentList = currentView === 'favorites' ? savedOutfits.filter(o => o.isFavorite) : savedOutfits.filter(o => !o.isFavorite);
            
            if (currentList.length === 0) { if (isSelectionMode) exitSelectionMode(); return; }

            if (!isSelectionMode) {
                let sortBtnText = "";
                let btnClass = "tool-btn";
                const currentState = getCurrentSortState();

                // --- BUTTON TEXT WITH ARROWS ---
                if (currentState === 'custom') {
                    sortBtnText = "Custom Order";
                } else if (currentState === 'reverse') {
                    sortBtnText = "▼";
                    btnClass += " active";
                } else if (currentState === 'chronological') {
                    sortBtnText = "▲";
                    btnClass += " active";
                }

                container.innerHTML = `
                    <button class="tool-btn" onclick="enterSelectionMode()">Select</button>
                    <button class="${btnClass}" onclick="cycleSort()">${sortBtnText}</button>
                `;
            } else {
                let actionsHTML = "";
                if (currentView === 'saved') {
                    actionsHTML = `<button class="tool-btn primary" onclick="bulkMoveToFavorites()">★ Move to Favorites</button><button class="tool-btn" onclick="bulkDownload()">⬇ Download Selected</button><button class="tool-btn danger" onclick="bulkDelete()">Delete Selected</button>`;
                } else {
                    actionsHTML = `<div class="spacer"></div><button class="tool-btn" onclick="bulkDownload()">⬇ Download Selected</button><button class="tool-btn danger" onclick="bulkRemoveFavorite()">Remove from Favorites</button>`;
                }
                container.innerHTML = `<button class="tool-btn" onclick="exitSelectionMode()">Cancel</button><button class="tool-btn" onclick="toggleSelectAll()">Select All</button>${currentView === 'saved' ? '<div class="spacer"></div>' : ''}${actionsHTML}`;
            }
        }

        function render() {
            const containerId = currentView === 'favorites' ? 'favorites-container' : 'saved-outfits-container';
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            
            if(isSelectionMode) container.classList.add('selection-active'); else container.classList.remove('selection-active');
            
            // TIP Management
            const tipId = currentView === 'favorites' ? 'drag-tip-favorites' : 'drag-tip-saved';
            const tip = document.getElementById(tipId);
            if(tip) {
                if(getCurrentSortState() === 'custom') tip.style.display = 'block';
                else tip.style.display = 'none';
            }

            // FILTER
            let listToRender = currentView === 'favorites' ? savedOutfits.filter(o => o.isFavorite) : savedOutfits.filter(o => !o.isFavorite);
            
            // SORT LOGIC
            const currentState = getCurrentSortState();
            if (currentState === 'reverse') {
                listToRender.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (currentState === 'chronological') {
                listToRender.sort((a, b) => new Date(a.date) - new Date(b.date));
            } 
            // If 'custom', we respect default array order

            renderToolbar();

            if (listToRender.length === 0) { container.innerHTML = "<p style='color:grey; padding: 20px;'>No outfits found.</p>"; return; }

            listToRender.forEach((outfit) => {
                const d = new Date(outfit.date);
                const dateStr = d.toLocaleDateString(undefined, { month:'short', day:'2-digit', year:'numeric' }) + ", " + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const card = document.createElement('div');
                card.className = 'outfit-card';
                if(selectedIds.has(outfit.id)) card.classList.add('selected');
                
                // DRAG ATTRIBUTES: Only if CUSTOM order and NOT selecting
                const canDrag = (currentState === 'custom') && !isSelectionMode;
                card.setAttribute('draggable', canDrag); 
                card.setAttribute('data-id', outfit.id);
                
                card.onclick = (e) => { if(!isSelectionMode) return; if(e.target.tagName === 'BUTTON') return; toggleSelect(outfit.id); };
                
                // Build image display - show clothing photo or user photo
                let imageHTML = 'Look';
                if (outfit.clothingPhoto) {
                    imageHTML = `<img src="data:image/jpeg;base64,${outfit.clothingPhoto}" style="width:100%; height:100%; object-fit:cover;" alt="Clothing">`;
                } else if (outfit.userPhoto) {
                    imageHTML = `<img src="data:image/jpeg;base64,${outfit.userPhoto}" style="width:100%; height:100%; object-fit:cover;" alt="User Photo">`;
                }
                
                card.innerHTML = `
                    <div class="select-overlay"><input type="checkbox" class="select-check" ${selectedIds.has(outfit.id) ? 'checked' : ''}></div>
                    <div class="outfit-img">${imageHTML}</div>
                    <div class="outfit-info"><h4>${outfit.name}</h4><p>${dateStr}</p></div>
                    <div class="card-actions">
                        <div class="action-group-left"><button class="text-btn edit-btn" onclick="renameOutfit(${outfit.id})">Rename</button><button class="text-btn delete-btn" onclick="deleteSingle(${outfit.id})">Delete</button></div>
                        <button class="download-btn" onclick="downloadOutfit(${outfit.id})" title="Download">⬇</button>
                    </div>`;
                
                if (canDrag) { 
                    card.addEventListener('dragstart', dragStart); 
                    card.addEventListener('dragover', dragOver); 
                    card.addEventListener('drop', dragDrop); 
                    card.addEventListener('dragenter', dragEnter); 
                    card.addEventListener('dragleave', dragLeave); 
                }
                container.appendChild(card);
            });
        }

        function enterSelectionMode() { isSelectionMode = true; render(); }
        function exitSelectionMode() { isSelectionMode = false; selectedIds.clear(); render(); }
        function toggleSelect(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); render(); }
        function toggleSelectAll() { const list = currentView === 'favorites' ? savedOutfits.filter(o => o.isFavorite) : savedOutfits.filter(o => !o.isFavorite); const allSelected = list.every(o => selectedIds.has(o.id)); if (allSelected) selectedIds.clear(); else list.forEach(o => selectedIds.add(o.id)); render(); }
        
        // INDEPENDENT CYCLE & SAVE
        function cycleSort() { 
            let currentState = getCurrentSortState();
            let nextState = 'custom';

            if (currentState === 'custom') nextState = 'reverse';
            else if (currentState === 'reverse') nextState = 'chronological';
            else nextState = 'custom';
            
            if (currentView === 'favorites') {
                favSortState = nextState;
                localStorage.setItem('vcto_fav_sort', nextState);
            } else {
                savedSortState = nextState;
                localStorage.setItem('vcto_saved_sort', nextState);
            }
            render(); 
        }

        function deleteSingle(id) { if (confirm("Delete this look?")) { savedOutfits = savedOutfits.filter(o => o.id !== id); saveData(); } }
        function bulkDelete() { if (selectedIds.size === 0) return alert("Select items first."); if (confirm(`Delete ${selectedIds.size} items?`)) { savedOutfits = savedOutfits.filter(o => !selectedIds.has(o.id)); saveData(); exitSelectionMode(); } }
        function bulkMoveToFavorites() { if (selectedIds.size === 0) return alert("Select items first."); savedOutfits.forEach(o => { if(selectedIds.has(o.id)) o.isFavorite = true; }); saveData(); exitSelectionMode(); }
        function bulkRemoveFavorite() { if (selectedIds.size === 0) return alert("Select items first."); savedOutfits.forEach(o => { if(selectedIds.has(o.id)) o.isFavorite = false; }); saveData(); exitSelectionMode(); }
        
        function bulkDownload() { 
            if (selectedIds.size === 0) return alert("Select items first."); 
            selectedIds.forEach(id => {
                const outfit = savedOutfits.find(o => o.id === id);
                if (outfit) downloadOutfit(id);
            });
            alert(`Downloaded ${selectedIds.size} items!`);
            exitSelectionMode(); 
        }
        
        function downloadOutfit(id) {
            const outfit = savedOutfits.find(o => o.id === id);
            if (!outfit) return;
            
            // Download clothing photo or user photo
            if (outfit.clothingPhoto) {
                const link = document.createElement('a');
                link.href = `data:image/jpeg;base64,${outfit.clothingPhoto}`;
                link.download = `${outfit.name.replace(/\s+/g, '_')}_${outfit.clothingFileName || 'clothing.jpg'}`;
                link.click();
            } else if (outfit.userPhoto) {
                const link = document.createElement('a');
                link.href = `data:image/jpeg;base64,${outfit.userPhoto}`;
                link.download = `${outfit.name.replace(/\s+/g, '_')}_${outfit.userFileName || 'photo.jpg'}`;
                link.click();
            } else {
                alert('No image available for this outfit');
            }
        }
        
        function renameOutfit(id) { const newName = prompt("New Name:"); if (newName) { savedOutfits.find(o => o.id === id).name = newName; saveData(); } }
        function saveData() { localStorage.setItem('vcto_saved_outfits', JSON.stringify(savedOutfits)); document.getElementById('total-outfits').innerText = savedOutfits.length; render(); }
        
        // --- DRAG AND DROP LOGIC ---
        let dragSrcEl = null;
        function dragStart(e) { 
            dragSrcEl = this; 
            e.dataTransfer.effectAllowed = 'move'; 
            this.classList.add('dragging'); 
        }
        function dragOver(e) { e.preventDefault(); return false; }
        function dragEnter(e) { this.style.borderColor = '#6366f1'; }
        function dragLeave(e) { this.style.borderColor = '#2d3748'; }
        function dragDrop(e) { 
            e.stopPropagation(); 
            this.style.borderColor = '#2d3748';
            if (dragSrcEl !== this) { 
                const srcId = parseInt(dragSrcEl.getAttribute('data-id')); 
                const targetId = parseInt(this.getAttribute('data-id')); 
                
                const srcIndex = savedOutfits.findIndex(o => o.id === srcId); 
                const targetIndex = savedOutfits.findIndex(o => o.id === targetId); 
                
                if (srcIndex > -1 && targetIndex > -1) {
                    const item = savedOutfits.splice(srcIndex, 1)[0];
                    savedOutfits.splice(targetIndex, 0, item);
                    saveData(); 
                }
            } 
            return false; 
        }

        function switchView(viewName) { 
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); 
            document.getElementById('link-' + viewName).classList.add('active'); 
            document.querySelectorAll('.dashboard-view').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-' + viewName).classList.add('active'); 
            currentView = viewName; 
            exitSelectionMode(); 
            const titles = { 'overview': 'Dashboard', 'saved': 'Saved Outfits', 'favorites': 'Favorites', 'settings': 'Settings' }; 
            document.getElementById('page-title').innerText = titles[viewName]; 
            if(viewName === 'saved' || viewName === 'favorites') render(); 
        }
        
        function deleteAccount() {
            const pass = document.getElementById('delete-password').value;
            const userDB = JSON.parse(localStorage.getItem('userDB')) || {};
            if (userDB[currentUser.email] && userDB[currentUser.email].password === pass) {
                delete userDB[currentUser.email];
                localStorage.setItem('userDB', JSON.stringify(userDB));
                localStorage.removeItem('currentUser');
                const main = document.getElementById('main-container');
                main.innerHTML = `<div style="text-align:center; padding-top: 5rem;"><h2 style="color:#ef4444; font-size:2rem;">Your Account Has Been Deleted</h2><p style="color:#a0aec0; margin-bottom:2rem;">We are sorry to see you go. You will be redirected shortly.</p></div>`;
                setTimeout(() => { window.location.href = "index.html"; }, 3000);
            } else { alert("Incorrect password."); }
        }
        function logout() { localStorage.removeItem('currentUser'); window.location.href = "index.html"; }

        render();
    </script>
</body>
</html>